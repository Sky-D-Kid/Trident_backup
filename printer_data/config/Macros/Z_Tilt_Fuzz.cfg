[gcode_macro Z_TILT_FUZZ]
description: "Z-Tilt mit zufälligem Fuzz um die Messpunkte"
variable_fuzz: 2.0
# Deine Z_TILT points hier als Pipe-getrennte Liste (x,y|x,y|x,y):
variable_points: "30,5|150,245|270,5"

gcode:
  # --- Parameter / Basisdaten ---
  {% set fuzz = (params.FUZZ|default(printer["gcode_macro Z_TILT_FUZZ"].fuzz))|float %}
  {% set pts = printer["gcode_macro Z_TILT_FUZZ"].points.split('|') %}
  {% set margin = 2.0 %}  # Sicherheitsabstand zu den Rändern

  # Achsgrenzen robust abfragen
  {% set xmin_axis = printer.toolhead.axis_minimum.x %}
  {% set ymin_axis = printer.toolhead.axis_minimum.y %}
  {% set xmax_axis = printer.toolhead.axis_maximum.x %}
  {% set ymax_axis = printer.toolhead.axis_maximum.y %}

  # --- Zufallswerte vorbereiten (0.1-mm Raster) ---
  {% set step = 0.1 %}
  {% set steps = (fuzz / step)|round(0, 'ceil')|int %}
  {% set choices = [] %}
  {% for i in range(-steps, steps + 1) %}
    {% set _ = choices.append((i * step)|round(3)) %}
  {% endfor %}

  # --- Zufallspunkte erzeugen und innerhalb der Achsgrenzen klemmen ---
  {% set rnd_points = [] %}
  {% for p in pts %}
    {% set xy = p.split(',') %}
    {% set x0 = (xy[0]|float) %}
    {% set y0 = (xy[1]|float) %}

    {% set dx = choices | random %}
    {% set dy = choices | random %}

    {% set x1 = (x0 + dx)|float %}
    {% set y1 = (y0 + dy)|float %}

    {% set xmin = (xmin_axis + margin) %}
    {% set xmax = (xmax_axis - margin) %}
    {% set ymin = (ymin_axis + margin) %}
    {% set ymax = (ymax_axis - margin) %}

    # clamp X/Y ohne Macro: erst oben kappen, dann unten anheben
    {% set x_tmp = [x1, xmax]|min %}
    {% set xC = [x_tmp, xmin]|max %}
    {% set y_tmp = [y1, ymax]|min %}
    {% set yC = [y_tmp, ymin]|max %}

    {% set xC = (xC|float)|round(3) %}
    {% set yC = (yC|float)|round(3) %}

    {% set _ = rnd_points.append("%0.3f,%0.3f"|format(xC, yC)) %}
  {% endfor %}

  # Für Z_TILT_ADJUST muss das Format "x,y x,y x,y" sein
  {% set points_arg = rnd_points | join(' ') %}

  # Robuste Statusausgabe (keine RESPOND-Parameter, alles in Jinja)
  { action_respond_info("Z_TILT_FUZZ: Punkte=%s  (FUZZ=%.2f mm)" % (points_arg, fuzz)) }

  # --- Laufparameter (wie in deinem [z_tilt], aber überschreibbar) ---
  {% set speed = (params.SPEED|default(200))|int %}
  {% set hmz = (params.HORIZONTAL_MOVE_Z|default(10))|float %}
  {% set retries = (params.RETRIES|default(5))|int %}
  {% set rtol = (params.RETRY_TOLERANCE|default(0.0075))|float %}

  # --- Sicher homing, wenn nötig ---
  {% if printer.toolhead.homed_axes != "xyz" %}
    G28
  {% endif %}

  # --- Z-Tilt mit den zufällig versetzten Punkten ausführen ---
  Z_TILT_ADJUST PROBE_POINTS="{points_arg}" SPEED={speed} HORIZONTAL_MOVE_Z={hmz} RETRIES={retries} RETRY_TOLERANCE={rtol}