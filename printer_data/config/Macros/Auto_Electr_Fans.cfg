[gcode_macro ELEC_FANS_AUTO]
description: Turn electronics_fans ON above target; OFF below (target - hyst)
variable_target: 60.0    # °C: ON at/above this temperature
variable_hyst:   3.0     # °C: OFF only when <= (target - hyst)
variable_speed:  0.6     # 0..1 fan speed when ON
gcode:
  # Pick your sensor: electronics_combined OR electronics_temp
  {% set T = printer['temperature_sensor electronics_combined'].temperature|float %}
  # {% set T = printer['temperature_sensor electronics_temp'].temperature|float %}

  # Allow live overrides: ELEC_FANS_AUTO TARGET=... HYST=... SPEED=...
  {% set target = params.TARGET|default(printer['gcode_macro ELEC_FANS_AUTO'].target)|float %}
  {% set hyst   = params.HYST|default(printer['gcode_macro ELEC_FANS_AUTO'].hyst)|float %}
  {% set speed  = params.SPEED|default(printer['gcode_macro ELEC_FANS_AUTO'].speed)|float %}

  # IF logic with hysteresis to prevent fan chatter
  {% if T >= target %}
    SET_FAN_SPEED FAN=electronics_fans SPEED={speed}
  {% elif T <= (target - hyst) %}
    SET_FAN_SPEED FAN=electronics_fans SPEED=0
  {% endif %}

# --- Periodic trigger (every 2 s) ---
[delayed_gcode _ELEC_FANS_TICK]
initial_duration: 30.0
gcode:
  ELEC_FANS_AUTO
  UPDATE_DELAYED_GCODE ID=_ELEC_FANS_TICK DURATION=10.0
