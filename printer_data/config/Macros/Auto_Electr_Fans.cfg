[gcode_macro _ELEC_FANS_AUTO]
description: Turn electronics_fans ON above target; OFF below (target - hyst)
variable_target: 60.0    # °C: ON at/above this temperature
variable_hyst:   3.0     # °C: OFF only when <= (target - hyst)
variable_speed:  0.6     # 0..1 fan speed when ON
gcode:
  # Pick your sensor: electronics_combined OR electronics_temp
  {% set T = printer['temperature_sensor electronics_combined'].temperature|float %}

  # IF logic with hysteresis to prevent fan chatter
  {% if T >= target %}
    SET_FAN_SPEED FAN=electronics_fans SPEED={speed}
  {% elif T <= (target - hyst) %}
    SET_FAN_SPEED FAN=electronics_fans SPEED=0
  {% endif %}

# --- Periodic trigger (every 30 s) ---
[delayed_gcode _ELEC_FANS_TICK]
initial_duration: 0.0
gcode:
  _ELEC_FANS_AUTO
  UPDATE_DELAYED_GCODE ID=_ELEC_FANS_TICK DURATION=30.0

  
[gcode_macro _ELEC_FANS_TIMER_START]
description: Startet den 10s-Check für Electronics-Fans
gcode:
  UPDATE_DELAYED_GCODE ID=_ELEC_FANS_TICK DURATION=30.0
  M118 ELEC_FANS_TIMER: gestartet (alle 10s)

[gcode_macro _ELEC_FANS_TIMER_STOP]
description: Stoppt den 10s-Check für Electronics-Fans
gcode:
  UPDATE_DELAYED_GCODE ID=_ELEC_FANS_TICK DURATION=0.0
  M118 ELEC_FANS_TIMER: gestoppt


# # Automatische Lüftersteuerung ohne G-Code
# [temperature_fan electronics_bay_control]
# pin: multi_pin: electronics_fans_pins
# sensor: temperature_sensor MCU
# sensor_type: temperature_host
# control: watermark
# target_temp: 65          # ON-ab 60°
# hysteresis: 3            # OFF bei <=62°
# min_temp: 0
# max_temp: 80
# min_speed: 0
# max_speed: 0.8
# shutdown_speed: 1.0
# kick_start_time: 0.5

